# Maintainer: KsenZ <aksenzov@gmail.com>

pkgname=tigervnc
pkgver=1.4.3
pkgrel=1
_xorgver=1.13.2
pkgdesc="suite of VNC servers and clients. VNC 4 branch of TightVNC."
arch=('i686' 'x86_64')
url="http://www.tigervnc.org"
license=('GPL')
depends=('pam' 'gnutls' 'libjpeg-turbo' 'libxft' 'libxinerama' 'libxcursor'
	 'libxtst' 'libxfont' 'pixman' 'xorg-xauth'
	 'xkeyboard-config' 'libgl' 'libgcrypt' 'perl')
makedepends=('cmake' 'nasm' 'xorg-font-utils' 'xorg-util-macros' 'bigreqsproto'
	     'compositeproto' 'damageproto' 'randrproto' 'resourceproto'
	     'scrnsaverproto' 'videoproto' 'xcmiscproto' 'xf86vidmodeproto'
	     'xtrans' 'mesa' 'glproto' 'dri2proto' 'imagemagick' 'librsvg')
options=(!libtool)
conflicts=('tightvnc')
source=(https://github.com/TigerVNC/${pkgname}/archive/v${pkgver}.tar.gz
	ftp://ftp.freedesktop.org/pub/xorg/individual/xserver/xorg-server-${_xorgver}.tar.bz2
	vncserver.service
	vncviewer.desktop)
#	xorg111.patch
#	xorg112.patch
#	xorg113.patch
#	xserver113.patch
#	glx.patch
#	gnutls.patch
#	gethomedir.patch
#	cmakelists.patch)

sha256sums=('0b2603db2b32dfd6e48f6f59618bd9819d187bfbb0c16218637d074a69756824'
            '3850adb89e9170ad85aea39d240279494c07779e50cd3cd60126028681209408'
            '5803952f879737226e4d6de8e6717c792a24a82754ffa799b3148d70e6a52d02'
            '1d1bed9148b7b4587b9e6d6e654359280c156053cf8e54914ac359c5caf3056c')

build() {
  cd ${srcdir}/${pkgname}-${pkgver}

  cp -r ${srcdir}/xorg-server-${_xorgver}/* unix/xserver
#  patch -Np1 -i ${srcdir}/gnutls.patch
#  patch -Np1 -i ${srcdir}/gethomedir.patch
#  patch -Np1 -i ${srcdir}/cmakelists.patch
#  patch -Np1 -i ${srcdir}/xorg111.patch
#  patch -Np1 -i ${srcdir}/xorg112.patch
#  patch -Np1 -i ${srcdir}/xorg113.patch
#  patch -Np1 -i ${srcdir}/glx.patch

  cmake -G "Unix Makefiles" -DCMAKE_INSTALL_PREFIX=/usr -DUSE_INCLUDED_FLTK=yes
  make
  make -C media

  cd unix/xserver
  patch -Np3 -i ${srcdir}/xserver113.patch
  autoreconf -fiv
  ./configure --prefix=/usr \
	--disable-static --disable-xinerama --without-dtrace \
	--disable-xorg --disable-xnest --disable-xvfb --disable-dmx \
	--disable-xwin --disable-xephyr --disable-kdrive --with-pic \
	--disable-config-dbus --disable-config-hal --disable-config-udev \
	--disable-unit-tests --disable-devel-docs --disable-selective-werror \
	--disable-dri --enable-dri2 --enable-glx --enable-glx-tls
  make
}

package() {
  cd ${srcdir}/${pkgname}-${pkgver}
  make DESTDIR=${pkgdir} install
  cd unix/xserver/hw/vnc
  make DESTDIR=${pkgdir} install
  sed -i 's/iconic/nowin/' ${pkgdir}/usr/bin/vncserver
  install -Dm0644 $srcdir/vncserver.service $pkgdir/usr/lib/systemd/system/vncserver.service
  install -dm0755 $pkgdir/usr/share/icons
  install -m0644 ${srcdir}/${pkgname}-${pkgver}/media/icons/* $pkgdir/usr/share/icons/
  install -Dm0644 $srcdir/vncviewer.desktop $pkgdir/usr/share/applications/vncviewer.desktop
}
